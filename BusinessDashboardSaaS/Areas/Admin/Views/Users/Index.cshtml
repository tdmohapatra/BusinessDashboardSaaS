@* ✅ Full User Management Page with Modal & Toasts *@
@using Microsoft.AspNetCore.Identity
@model IEnumerable<IdentityUser>
@inject UserManager<IdentityUser> UserManager

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Manage Users";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

<h2 class="mb-4">👥 Manage Users</h2>

<div class="mb-3 text-end">
    <a href="/Identity/Account/Register" class="btn btn-success">
        <i class="bi bi-person-plus-fill"></i> Create New User
    </a>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Email</th>
                <th>User Name</th>
                <th>Status</th>
                <th>Roles</th>
                <th style="width: 180px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Any())
            {
                var index = 1;
                foreach (var user in Model)
                {
                    var roles = await UserManager.GetRolesAsync(user);
                    <tr>
                        <td>@index</td>
                        <td>@user.Email</td>
                        <td>@user.UserName</td>
                        <td>
                            @if (user.EmailConfirmed)
                            {
                                <span class="badge bg-success">Confirmed</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Pending</span>
                            }
                        </td>
                        <td>
                            @foreach (var role in roles)
                            {
                                <span class="badge bg-info text-dark me-1">@role</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group">
                                <a asp-area="Admin" asp-controller="Users" asp-action="Edit" asp-route-id="@user.Id" class="btn btn-sm btn-warning" title="Edit">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a asp-area="Admin" asp-controller="Users" asp-action="EditRoles" asp-route-id="@user.Id" class="btn btn-sm btn-primary" title="Edit Roles">
                                    <i class="bi bi-shield-lock"></i>
                                </a>
                                <button class="btn btn-sm btn-danger" title="Delete"
                                        onclick="handleDelete('@user.Id', '@user.UserName')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    index++;
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center text-muted">No users found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<partial name="_ToastModalPartial" />

@section Scripts {
    <script>
        function handleDelete(userId, userName) {
            showModal(
                "Delete User",
                `Are you sure you want to delete <strong>${userName}</strong>?`,
                "Delete",
                function () {
                    window.location.href = `/Admin/Users/Delete/${userId}`;
                }
            );
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("success")) {
            showToast("Action completed successfully.");
        }
    </script>
}
